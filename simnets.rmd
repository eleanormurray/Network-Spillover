---
title: "Network Simulation Models"
output: html_notebook
date: '2022-07-18'
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Libraries

```{r libraries}
require(EpiModel)
require(igraph)
require(reticulate)
require(dplyr)
require(ggplot2)
require(desplot)
require(patchwork)
require(purrr)
require(furrr)
require(tidyverse)
require(RColorBrewer)
# require(gganimate)
require(ggforce)
require(ggpubr)
plan("multisession", workers=availableCores()/4)

set.seed(1000)
options(future.rng.onMisuse="ignore")
```

## Parameters

```{r params}
N<-50 #network population/ graph order
model="WS"
eprob<-0.1 #edge formation probability for ER model 
pow<-1 #preferential attachment power for BA model
nb<-20 # neighborhood parameter for small-world model
rprob<-0.05 #rewiring probability for small-world model
phiv<-0.1 # underlying hiv prevalence
PrEP1<-0.2 # PrEP assignment coverage in control treatment (a) 
PrEP2<-0.4 # PrEP assignment coverage in counterfactual treatment (a*)
#HIV risk by contact and PrEP allocation 
p1<-0.2 #P(HIV|Contact and -PrEP)
p2<-0.1 #P(HIV|Contact and PrEP)
nsim<-200
plots=T
scale="additive"
```

## Simulation Function

```{r simulation}
sim<-function(N=20,phiv=0.1,PrEP1=0.1,PrEP2=0.2, p1=0.2,p2=0.1, plots=F, scale=c("additive","multiplicative"),model=c("ER","BA","WS"),eprob=0.1,pow=1,nb=5,rprob=0.05){
  args<-c(N,phiv,PrEP1,PrEP2,p1,p2,scale,model,eprob,pow,nb,rprob)
  names(args)<-c("N","phiv","PrEP1","PrEP2","p1","p2","scale","model","eprob","pow","nb","rprob")
   #parameter check
scale<-match.arg(scale)
model<-match.arg(model)
# plot a random graph, 3 color options
#control scenario graph, PrEP1% assignment prob
g<-if(model=="ER"){sample_gnp(N,eprob)} else if(model=="BA"){sample_pa(N,power=pow,directed=FALSE)} else if(model=="WS"){sample_smallworld(dim=1,size=N,nei=nb,p=rprob)}
l_hiv_g<-round((gorder(g)*phiv),0)
l_PrEP1_g<-round(((gorder(g)-l_hiv_g)*PrEP1),0)
l_sus_g<-round((gorder(g)-(l_hiv_g+l_PrEP1_g)),0)
vertex_attr(g) <- list(color=c(rep("red", l_hiv_g), rep("blue",l_PrEP1_g), rep("black",l_sus_g)))
if(plots){coords=layout_nicely(g); plot(g, vertex.size=10,vertex.label.cex=1, vertex.label.dist=2,main="Control",layout=coords)}
inf_contact_g<-setdiff(unlist(adjacent_vertices(g,v=V(g)[color=="red"])), V(g)[color=="red"])
#compute P(HIV|PrEP)
treat_g<-V(g)[V(g)$color=="blue"]
treat_inf_contact_g<- V(g)[inf_contact_g][which(V(g)[inf_contact_g]$color=="blue")]
g<-set_vertex_attr(g,name="color",index=inf_contact_g,value="orange")
g<-set_vertex_attr(g, name="color",index=treat_inf_contact_g,value="purple")
if(plots){plot(g, vertex.size=10,vertex.label.cex=1, vertex.label.dist=2,main="Control",layout=coords)}
hiv_given_prep_g<-ifelse(length(treat_g)!=0,(length(treat_inf_contact_g)*p2)/length(treat_g),0)
#Compute P(HIV|-PrEP)
no_treat_g<-V(g)[V(g)$color %in% c("black","orange")]
no_treat_inf_contact_g<-V(g)[V(g)$color=="orange"]
hiv_given_no_prep_g<-ifelse(length(no_treat_g)!=0,(length(no_treat_inf_contact_g)*p1)/length(no_treat_g),0)
#Randomly assign 20% overall (shuffle attributes)
l_hiv_h<-round((gorder(g)*phiv),0)
l_PrEP2_h<-round(((gorder(g)-l_hiv_h)*PrEP2),0)
l_sus_h<-round((gorder(g)-(l_hiv_h+l_PrEP2_h)),0)
h<-set_vertex_attr(g,"color",value=c(rep("red",l_hiv_h), sample(c(rep("blue",l_PrEP2_h), rep("black", l_sus_h)))))
if(plots){plot(h,vertex.size=10,vertex.label.cex=1, vertex.label.dist=2,main="Random overall", layout=coords)}
inf_contact_h<-setdiff(unlist(adjacent_vertices(h,v=V(h)[color=="red"])), V(h)[color=="red"])
#Compute P(HIV|PrEP)
treat_h<-V(h)[V(h)$color=="blue"]
treat_inf_contact_h<-V(h)[inf_contact_h][which(V(h)[inf_contact_h]$color=="blue")]
h<-set_vertex_attr(h,name="color",index=inf_contact_h,value="orange")
h<-set_vertex_attr(h, name="color",index=treat_inf_contact_h,value="purple")
if(plots){plot(h,vertex.size=10,vertex.label.cex=1, vertex.label.dist=2,main="Random overall", layout=coords)}
hiv_given_prep_h<-ifelse(length(treat_h)!=0,(length(treat_inf_contact_h)*p2)/length(treat_h),0)
#Compute P(HIV|-PrEP)
no_treat_h<-V(h)[V(h)$color%in% c("black","orange")]
no_treat_inf_contact_h<-V(h)[V(h)$color=="orange"]
hiv_given_no_prep_h<-ifelse(length(no_treat_h)!=0,(length(no_treat_inf_contact_h)*p1)/length(no_treat_h),0)
#duplicate network structure, additional PrEP2-PrEP1% treated
l_hiv_j<-round((gorder(g)*phiv),0)
l_PrEP2_j<-round(((gorder(g)-l_hiv_j)*PrEP2),0)
l_sus_j<-round((gorder(g)-(l_hiv_j+l_PrEP2_j)),0)
j<-set_vertex_attr(g,"color",value=c(rep("red", l_hiv_j), rep("blue",l_PrEP2_j), rep("black", l_sus_j)))
if(plots){plot(j,  vertex.size=10,vertex.label.cex=1, vertex.label.dist=2,main="Random additional", layout=coords)}
inf_contact_j<-setdiff(unlist(adjacent_vertices(j,v=V(j)[color=="red"])), V(j)[color=="red"])
#compute (HIV|PrEP)
treat_j<-V(j)[V(j)$color=="blue"]
treat_inf_contact_j<-V(j)[inf_contact_j][which(V(j)[inf_contact_j]$color=="blue")]
j<-set_vertex_attr(j,name="color",index=inf_contact_j,value="orange")
j<-set_vertex_attr(j, name="color",index=treat_inf_contact_j,value="purple")
if(plots){plot(j,  vertex.size=10,vertex.label.cex=1, vertex.label.dist=2,main="Random additional", layout=coords)}
hiv_given_prep_j<-ifelse(length(treat_j)!=0,(length(treat_inf_contact_j)*p2)/length(treat_j),0)
#Compute P(HIV|-PrEP)
no_treat_j<-V(j)[V(j)$color%in% c("black","orange")]
no_treat_inf_contact_j<-V(j)[V(j)$color=="orange"]
hiv_given_no_prep_j<-ifelse(length(no_treat_j)!=0,(length(no_treat_inf_contact_j)*p1)/length(no_treat_j),0)
# plot a random graph, 3 color options
k <- if(model=="ER"){sample_gnp(N,eprob)} else if(model=="BA"){sample_pa(N,power=pow,directed=FALSE)} else if(model=="WS"){sample_smallworld(dim=1,size=N,nei=nb,p=rprob)}
l_hiv_k<-round((gorder(k)*phiv),0)
l_PrEP2_k<-round(((gorder(k)-l_hiv_k)*PrEP2),0)
l_sus_k<-round((gorder(k)-(l_hiv_k+l_PrEP2_k)),0)
vertex_attr(k) <- list(color =c(rep("red", l_hiv_k), rep("blue",l_PrEP2_k), rep("black", l_sus_k)))
if(plots){plot(k,  vertex.size=10,vertex.label.cex=1, vertex.label.dist=2,main="Regenerated", layout=coords)}
inf_contact_k<-setdiff(unlist(adjacent_vertices(k,v=V(k)[color=="red"])), V(k)[color=="red"])
#Compute P(HIV|PrEP)
treat_k<-V(k)[V(k)$color=="blue"]
treat_inf_contact_k<-V(k)[inf_contact_k][which(V(k)[inf_contact_k]$color=="blue")]
k<-set_vertex_attr(k,name="color",index=inf_contact_k,value="orange")
k<-set_vertex_attr(k, name="color",index=treat_inf_contact_k,value="purple")
if(plots){plot(k,  vertex.size=10,vertex.label.cex=1, vertex.label.dist=2,main="Regenerated", layout=coords)}
hiv_given_prep_k<-ifelse(length(treat_k)!=0,(length(treat_inf_contact_k)*p2)/length(treat_k),0)
#Compute P(HIV|-PrEP)
no_treat_k<-V(k)[V(k)$color%in% c("black","orange")]
no_treat_inf_contact_k<-V(k)[V(k)$color=="orange"]
hiv_given_no_prep_k<-ifelse(length(no_treat_k)!=0,(length(no_treat_inf_contact_k)*p1)/length(no_treat_k),0)
#Network Summary Statistics
stats_g<-c(
Co_g<-count_components(g), #Number of Components
Cs_g<-max(components(g)$csize),#Largest Component Size
B_g<-mean(betweenness(g)),# Average Betweenness Centrality
De_g<-edge_density(g),#Density
Ce_g<-centr_degree(g)$centralization,#Degree Centralization
G_g<-mean_distance(g),#Average geodesic distance
Di_g<-diameter(g),#Network Diameter
T_g<-transitivity(g),#Transitivity/Clustering
K_g<-sum(coreness(g)==2)/length(coreness(g)),#Proportion of nodes in 2-cores
As_g<-assortativity_degree(g,directed=F) #Degree Assortativity
)
names(stats_g)<-c("Number of Components g","Largest Component Size g", "Avg. Betweenness g","Density g","Degree Centralization g","Avg. Geodesic Distance g", "Diameter g", "Transitivity g","Proportion of nodes in 2-cores g", "Degree Assortativity g")
stats_k<-c(
Co_k<-count_components(k), #Number of Components
Cs_k<-max(components(k)$csize),#Largest Component Size
B_k<-mean(betweenness(k)),# Average Betweenness Centrality
De_k<-edge_density(k),#Density
Ce_k<-centr_degree(k)$centralization,#Degree Centralization
G_k<-mean_distance(k),#Average geodesic distance
Di_k<-diameter(k),#Network Diameter
T_k<-transitivity(k),#Transitivity/Clustering
K_k<-sum(coreness(k)==2)/length(coreness(k)),#Proportion of nodes in 2-cores,
As_k<-assortativity_degree(k,directed=F) #Degree Assortativity
)
names(stats_k)<-c("Number of Components k","Largest Component Size k", "Avg. Betweenness k","Density k","Degree Centralization k","Avg. Geodesic Distance k", "Diameter k", "Transitivity k","Proportion of nodes in 2-cores k", "Degree Assortativity k")
# Combine effect estimates
prep<-c(hiv_given_prep_g,hiv_given_prep_h,hiv_given_prep_j,hiv_given_prep_k)
names(prep)<-c("hiv_given_prep_g","hiv_given_prep_h","hiv_given_prep_j","hiv_given_prep_k")
no_prep<-c(hiv_given_no_prep_g,hiv_given_no_prep_h,hiv_given_no_prep_j,hiv_given_no_prep_k)
names(no_prep)<-c("hiv_given_no_prep_g","hiv_given_no_prep_h","hiv_given_no_prep_j","hiv_given_no_prep_k")
ef<-prep+no_prep
names(ef)<-c("control,","random","additive","regenerated")
#compute causal contrasts
if(scale=="additive"){cc<-as.data.frame(t(ef[-1]-ef[1]))}
# else if(scale=="multiplicative"){ef<-ef+1;
# cc<-as.data.frame(t(ef[-1])/ef[1]); 
#if(is.na(t(ef[-1]/ef[1]))||is.infinite(t(ef[-1]/ef[1]))){print(ef)}
# }
names(cc)<-c("random","additive","regenerated")
res<-cbind(as.data.frame(t(args)),as.data.frame(t(prep)),as.data.frame(t(no_prep)),cc, as.data.frame(t(stats_g)),as.data.frame(t(stats_k)))
names(res)<-c(names(args),names(prep), names(no_prep),names(cc),names(stats_g),names(stats_k))
return(res)
}
```

## Parallel resampling

```{r simulation parallel}
sim_par<-function(N=20,phiv=0.1,PrEP1=0.1,PrEP2=0.2, p1=0.2,p2=0.1, scale="additive",model="ER",eprob=0.1,pow=1,nb=5,rprob=0.05,nsim=200){
res<-future_map_dfr(1:nsim,~sim(N=N,phiv=phiv,PrEP1=PrEP1,PrEP2=PrEP2,p1=p1,p2=p2,scale=scale,model=model,eprob=eprob,pow=pow,nb=nb,rprob=rprob))
res<-cbind(res,nsim)
return(res)}
```

Trying to parallellize sim rather than use simpar, use rerun from purrr?
Don't use rerun, use a map with sim_par?

```{r}
col_list=c("random","additive","regenerated")
```


## Results 

### Check sensitivity to network size, plot heatmap by N

```{r}
params_N<-tidyr::expand_grid(N=c(20,200), model="ER",phiv=phiv,PrEP1=PrEP1,PrEP2=PrEP2,p1=seq(0.1,1,0.1),p2=seq(0.1,1,0.1), nsim=nsim, scale="additive")
# future::plan(
#       list(
#         future::tweak(
#           future::multisession, 
#           workers = 2), 
#         future::tweak(
#           future::multisession,
#           workers = 12)
#         )
#       )
res_N<-future_pmap_dfr(params_N,sim_par)
means_N<-res_N%>%group_by(N,p1,p2)%>%summarise(across(all_of(col_list),mean))
var_N<-res_N%>%group_by(N,p1,p2)%>%summarise(across(all_of(col_list),var))
save(res_N,means_N,var_N,file="Network Size Results.RData")
```

### check sensitivity to sample size-cluster?

```{r}
params_samp<-expand.grid(N=20,phiv=phiv,PrEP1=PrEP1,PrEP2=PrEP2,p1=seq(0.1,1,0.1),p2=seq(0.1,1,0.1),nsim=10^seq(2,4,1))
# future::plan(
      # list(
      #   future::tweak(
      #     future::multisession,
      #     workers = 4),
      #   future::tweak(
      #     future::multisession,
      #     workers = 6)
      #   )
      # )
system.time(res_samp<-future_pmap_dfr(params_samp,sim_par))
means_samp<-res_samp%>%group_by(nsim,p1,p2)%>%summarise(across(col_list,mean))
var_samp<-res_samp%>%group_by(nsim,p1,p2)%>%summarise(across(col_list,var))
beepr::beep(8)
save(res_samp,means_samp,var_samp,file=paste("N=",N,"Sample size results.RData", sep=" "))
```

### Increase underlying HIV prevalence phiv

```{r}
params_phiv<-expand.grid(N=20,phiv=seq(0.1,1,0.1),PrEP1=PrEP1,PrEP2=PrEP2,p1=seq(0.1,1,0.1),p2=seq(0.1,1,0.1),nsim=nsim)
future::plan(
      list(
        future::tweak(
          future::multisession, 
          workers = 3), 
        future::tweak(
          future::multisession,
          workers = 8)
        )
      )
res_phiv<-future_pmap_dfr(params_phiv,sim_par)
means_phiv<-res_phiv%>%group_by(across(all_of(c("phiv","p1","p2"))))%>%summarise(across(col_list,mean))
var_phiv<-res_phiv%>%group_by(across(all_of(c("phiv","p1","p2"))))%>%summarise(across(col_list,var))
beepr::beep(8)
save(res_phiv,means_phiv,var_phiv,file="HIV Prevalence Results.RData")
```

### Increasing p1 only

```{r}
params_p1<-expand_grid(N=20,phiv=phiv,PrEP1=PrEP1,PrEP2=PrEP2,p1=seq(0.1,1,0.01),p2=0.1,nsim=nsim)
# future::plan("multisession",workers=future::availableCores())
res_p1<-future_pmap_dfr(params_p1,sim_par)
means_p1<-res_p1%>%group_by(p1,p2)%>%summarise(across(col_list,mean))
var_p1<-res_p1%>%group_by(p1,p2)%>%summarise(across(col_list,var))
save(res_p1,means_p1,var_p1,file="p1 Results.RData")
```

### Increasing p2 only

```{r}
params_p2<-expand_grid(N=20,phiv=0.1,PrEP1=PrEP1,PrEP2=PrEP2,p2=seq(0.1,1,0.01),p1=0.1,nsim=nsim)
res_p2<-future_pmap_dfr(params_p2,sim_par)
means_p2<-res_p2%>%group_by(p2,p1)%>%summarise(across(col_list,mean))
var_p2<-res_p2%>%group_by(p2,p1)%>%summarise(across(col_list,var))
save(res_p2,means_p2,var_p2,file="p2 Results.RData")
```

### Increasing PrEP1 and PrEP2

```{r}
params_PrEP<-expand_grid(N=20,phiv=0.1,PrEP1=seq(0.1,1,0.1),PrEP2=seq(0.1,1,0.1),p1=seq(0.1,1,0.1),p2=seq(0.1,1,0.1),nsim=nsim)%>%filter(PrEP2>PrEP1)
# plan(multisession(workers = availableCores()))
# future::plan(
#       list(
#         future::tweak(
#           future::multisession, 
#           workers = 4), 
#         future::tweak(
#           future::multisession,
#           workers = 6)
#         )
#       )

system.time(res_PrEP<-future_pmap_dfr(params_PrEP,sim_par))
beepr::beep(8)
means_PrEP<-res_PrEP%>%group_by(across(all_of(c("PrEP1","PrEP2","p1","p2"))))%>%summarise(across(col_list,mean), .groups = "keep")
var_PrEP<-res_PrEP%>%group_by(across(all_of(c("PrEP1","PrEP2","p1","p2"))))%>%summarise(across(col_list,var), .groups = "keep")
save(res_PrEP,means_PrEP,var_PrEP,file="PrEP Results.RData")
```


### Change network generative model with defaults

```{r}
params_model<-expand.grid(N=N,phiv=0.1,model=c("ER","BA","WS"),PrEP1=PrEP1,PrEP2=PrEP2,p1=seq(0.1,1,0.1),p2=seq(0.1,1,0.1),nsim=nsim, stringsAsFactors = F)
plan("multisession",workers=availableCores()/4)
res_model<-future_pmap_dfr(params_model,sim_par)
means_model<-res_model%>%group_by(across(all_of(c("model","p1","p2"))))%>%summarise(across(col_list,mean))
var_model<-res_model%>%group_by(across(all_of(c("model","p1","p2"))))%>%summarise(across(col_list,var))
save(res_model,means_model,var_model,file="Generative Model Results.RData")
```

### Change ER edge probability

```{r}
params_eprob<-expand.grid(N=N,eprob=seq(0.1,1,0.1),phiv=0.1,PrEP1=PrEP1,PrEP2=PrEP2,p1=seq(0.1,1,0.1),p2=seq(0.1,1,0.1),nsim=nsim)
res_eprob<-future_pmap_dfr(params_eprob,sim_par)
means_eprob<-res_eprob%>%group_by(across(all_of(c("eprob","p1","p2"))))%>%summarise(across(col_list,mean))
var_eprob<-res_eprob%>%group_by(across(all_of(c("eprob","p1","p2"))))%>%summarise(across(col_list,var))
save(res_eprob,means_eprob,var_eprob,file="ER edge probability Results.RData")
```

### Change BA preferential attachment power

```{r}
params_pow<-expand.grid(N=N,phiv=0.1,PrEP1=0.2,PrEP2=0.4,p1=seq(0.1,1,0.1),p2=seq(0.1,1,0.1), model="BA",pow=seq(1,2,0.1), nsim=nsim,stringsAsFactors = F)
res_pow<-future_pmap_dfr(params_pow,sim_par)
means_pow<-res_pow%>%group_by(across(all_of(c("pow","p1","p2"))))%>%summarise(across(col_list,mean))
var_pow<-res_pow%>%group_by(across(all_of(c("pow","p1","p2"))))%>%summarise(across(col_list,var))
save(res_pow,means_pow,var_pow,file="Preferential attachment power results.RData")
```


### Change Small-World neighborhood size

```{r}
params_nb<-expand.grid(N=N,phiv=phiv,PrEP1=PrEP1,PrEP2=PrEP2, p1=seq(0.1,1,0.1),p2=seq(0.1,1,0.1), scale="additive",model="WS",eprob=eprob,pow=pow,nb=seq(5,N/2,5),rprob=rprob,nsim=nsim,stringsAsFactors = F)
plan("multisession",workers=availableCores()/4)
res_nb<-future_pmap_dfr(params_nb,sim_par)
means_nb<-res_nb%>%group_by(across(all_of(c("nb","p1","p2"))))%>%summarise(across(col_list,mean))
var_nb<-res_nb%>%group_by(across(all_of(c("nb","p1","p2"))))%>%summarise(across(col_list,var))
save(res_nb,means_nb,var_nb,file="Small World Neighborhood Size Results.RData")
```


### Change Small-World rewiring probability

```{r}
params_rprob<-expand.grid(N=N,phiv=phiv,PrEP1=PrEP1,PrEP2=PrEP2, p1=seq(0.1,1,0.1),p2=seq(0.1,1,0.1), scale="additive",model="WS",eprob=eprob,pow=pow,nb=nb,rprob=seq(0.05,1,0.1),nsim=nsim,stringsAsFactors = F)
res_rprob<-future_pmap_dfr(params_rprob,sim_par)
means_rprob<-res_rprob%>%group_by(across(all_of(c("rprob","p1","p2"))))%>%summarise(across(col_list,mean))
var_rprob<-res_rprob%>%group_by(across(all_of(c("rprob","p1","p2"))))%>%summarise(across(col_list,var))
save(res_rprob,means_rprob,var_rprob,file="Small World Rewiring Probability Results.RData")
```



## Figures

### Mean plots

#### Network Size

```{r}
lims_means_N<-c(min(means_N[,col_list]),max(means_N[,col_list]))
N_plot_1<-ggplot(means_N,aes_string(x="p1",y="p2", fill=col_list[1]))+geom_tile()+facet_grid(~N)+scale_fill_gradientn(limits=lims_means_N,colors=brewer.pal(6,name="RdYlBu"))+ xlab("P(HIV|Contact and -PrEP)")+ylab("P(HIV|Contact and PrEP)")
N_plot_2<-ggplot(means_N,aes_string(x="p1",y="p2", fill=col_list[2]))+geom_tile()+facet_grid(~N)+scale_fill_gradientn(limits=lims_means_N,colors=brewer.pal(6,name="RdYlBu"))+xlab("P(HIV|Contact and -PrEP)")+ylab("P(HIV|Contact and PrEP)")
N_plot_3<-ggplot(means_N,aes_string(x="p1",y="p2", fill=col_list[3]))+geom_tile()+facet_grid(~N)+scale_fill_gradientn(limits=lims_means_N,colors=brewer.pal(6,name="RdYlBu"))+xlab("P(HIV|Contact and -PrEP)")+ylab("P(HIV|Contact and PrEP)")
ggsave(plot=N_plot_2/N_plot_1/N_plot_3 +    # Create grid of plots with title
  plot_annotation(title = "Contrast Estimate Mean by Network Size and Allocation" ) & 
  theme(plot.title = element_text(hjust = 0.5)),
file="Network Size Mean Plot.png",path="Figures/")
# ggsave(N_plot_2/N_plot_1/N_plot_3,file="Network Size Mean Plot.png",path="Figures/")
```


#### Sample size

```{r}
lims_means_samp<-c(min(means_samp[,col_list]),max(means_samp[,col_list]))
samp_plot_1<-ggplot(means_samp,aes_string(x="p1",y="p2",fill=col_list[1]))+geom_tile()+facet_grid(~nsim)+scale_fill_gradientn(limits=lims_means_samp, colors=brewer.pal(5,name="RdYlBu"))+xlab("P(HIV|Contact and -PrEP)")+ylab("P(HIV|Contact and PrEP)")
samp_plot_2<-ggplot(means_samp,aes_string(x="p1",y="p2",fill=col_list[2]))+geom_tile()+facet_grid(~nsim)+scale_fill_gradientn(limits= lims_means_samp, colors=brewer.pal(5,name="RdYlBu"))+xlab("P(HIV|Contact and -PrEP)")+ylab("P(HIV|Contact and PrEP)")
samp_plot_3<-ggplot(means_samp,aes_string(x="p1",y="p2",fill=col_list[3]))+geom_tile()+facet_grid(~nsim)+scale_fill_gradientn(limits=lims_means_samp, colors=brewer.pal(5,name="RdYlBu"))+xlab("P(HIV|Contact and -PrEP)")+ylab("P(HIV|Contact and PrEP)")
samp_plot_2/samp_plot_1/samp_plot_3
ggsave(plot=samp_plot_2/samp_plot_1/samp_plot_3+    # Create grid of plots with title
  plot_annotation(title = "Contrast Estimate Mean by Sample Size and Allocation" ) & 
  theme(plot.title = element_text(hjust = 0.5)),
file="Sample Size Mean plots.png",path="Figures/")
```

#### HIV prevalence

```{r}
lims_means_phiv<-c(min(means_phiv[means_phiv$phiv<0.9,col_list]),max(means_phiv[means_phiv$phiv<0.9,col_list]))
phiv_plot_1<-means_phiv%>%filter(phiv<0.9)%>%ggplot(aes_string(x="p1",y="p2",fill=col_list[1]))+scale_x_discrete(guide = guide_axis(n.dodge=2))+geom_tile()+facet_grid(~phiv)+scale_fill_gradientn(limits=lims_means_phiv,n.breaks=10, colors=brewer.pal(10,name="RdYlBu"))+xlab("P(HIV|Contact and -PrEP)")+ylab("P(HIV|Contact and PrEP)")
phiv_plot_2<-means_phiv%>%filter(phiv<0.9)%>%ggplot(aes_string(x="p1",y="p2",fill=col_list[2]))+geom_tile()+facet_grid(~phiv)+scale_fill_gradientn(limits=lims_means_phiv,n.breaks=10,colors=brewer.pal(10,name="RdYlBu"))+xlab("P(HIV|Contact and -PrEP)")+ylab("P(HIV|Contact and PrEP)")+scale_x_discrete(guide = guide_axis(n.dodge=2))
phiv_plot_3<-means_phiv%>%filter(phiv<0.9)%>%ggplot(aes_string(x="p1",y="p2",fill=col_list[3]))+geom_tile()+facet_grid(~phiv)+scale_fill_gradientn(limits=lims_means_phiv,n.breaks=10,colors=brewer.pal(10,name="RdYlBu"))+xlab("P(HIV|Contact and -PrEP)")+ylab("P(HIV|Contact and PrEP)")+scale_x_discrete(guide = guide_axis(n.dodge=2))
ggarrange(phiv_plot_2/phiv_plot_1/phiv_plot_3)
ggsave(plot=phiv_plot_2/phiv_plot_1/phiv_plot_3+    # Create grid of plots with title
  plot_annotation(title = "Contrast Estimate Mean by HIV Prevalence and Allocation" ) & 
  theme(plot.title = element_text(hjust = 0.5)),
file="HIV Prevalence Mean plots.png", path="Figures/")
```

#### P(HIV|Contact and -PrEP)

```{r}
lims_means_p1<-c(min(means_p1[,col_list]),max(means_p1[,col_list]))
p1_plot_1<-ggplot(means_p1,aes_string(x="p1",y=col_list[1]))+geom_point()+scale_y_continuous(limits=lims_means_p1)+xlab("P(HIV|Contact and -PrEP)")+scale_x_discrete(breaks=seq(0.1,1,0.05))
p1_plot_2<-ggplot(means_p1,aes_string(x="p1",y=col_list[2]))+geom_point()+scale_y_continuous(limits=lims_means_p1)+xlab("P(HIV|Contact and -PrEP)")+scale_x_discrete(breaks=seq(0.1,1,0.05))
p1_plot_3<-ggplot(means_p1,aes_string(x="p1",y=col_list[3]))+geom_point()+scale_y_continuous(limits=lims_means_p1)+xlab("P(HIV|Contact and -PrEP)")+scale_x_discrete(breaks=seq(0.1,1,0.05))
p1_plot_2/p1_plot_1/p1_plot_3
ggsave(plot=p1_plot_2/p1_plot_1/p1_plot_3 +    # Create grid of plots with title
  plot_annotation(title = "Contrast Estimate Mean by P(HIV|Contact and -PrEP) and Allocation" ) & 
  theme(plot.title = element_text(hjust = 0.5)),
file="p1 Mean plots.png", path="Figures") 
```

#### P(HIV|Contact and PrEP)

```{r}
lims_means_p2<-c(min(means_p2[,col_list]),max(means_p2[,col_list]))
p2_plot_1<-ggplot(means_p2,aes_string(x="p2",y=col_list[1]))+geom_point()+scale_y_continuous(limits=lims_means_p2)+xlab("P(HIV|Contact and PrEP)")+scale_x_discrete(breaks=seq(0.1,1,0.05))
p2_plot_2<-ggplot(means_p2,aes_string(x="p2",y=col_list[2]))+geom_point()+scale_y_continuous(limits=lims_means_p2)+xlab("P(HIV|Contact and PrEP)")+scale_x_discrete(breaks=seq(0.1,1,0.05))
p2_plot_3<-ggplot(means_p2,aes_string(x="p2",y=col_list[3]))+geom_point()+scale_y_continuous(limits=lims_means_p2)+xlab("P(HIV|Contact and PrEP)")+scale_x_discrete(breaks=seq(0.1,1,0.05))
p2_plot_2/p2_plot_1/p2_plot_3
ggsave(plot=p2_plot_2/p2_plot_1/p2_plot_3+    # Create grid of plots with title
  plot_annotation(title = "Contrast Estimate Mean by P(HIV|Contact and PrEP) and Allocation" ) & 
  theme(plot.title = element_text(hjust = 0.5)),file="p2 Mean plots.png", path="Figures/")
```

#### PrEP1 and PrEP2- under construction

```{r PrEP grid}
lims_means_PrEP<-c(min(means_PrEP[means_PrEP$PrEP2<1,col_list]),max(means_PrEP[means_PrEP$PrEP2<1,col_list]))
PrEP_plot_1<-means_PrEP%>%filter(PrEP2<1)%>%ggplot(aes_string(x="p1",y="p2",fill=col_list[1]))+geom_tile()+facet_grid(PrEP1~PrEP2,scales="free")+scale_fill_gradientn(limits=lims_means_PrEP, colors=brewer.pal(5,name="RdYlBu"))+xlab("P(HIV|Contact and -PrEP)")+ylab("P(HIV|Contact and PrEP)")+ggtitle("Mean contrast estimate in random PrEP allocation by PrEP coverage")+scale_x_discrete(guide = guide_axis(n.dodge=2))
PrEP_plot_2<-means_PrEP%>%filter(PrEP2<1)%>%ggplot(aes_string(x="p1",y="p2",fill=col_list[2]))+geom_tile()+facet_grid(PrEP1~PrEP2,scales="free")+scale_fill_gradientn(limits=lims_means_PrEP, colors=brewer.pal(5,name="RdYlBu"))+xlab("P(HIV|Contact and -PrEP)")+ylab("P(HIV|Contact and PrEP)")+ggtitle("Mean contrast estimate in additive PrEP allocation by PrEP coverage")+scale_x_discrete(guide = guide_axis(n.dodge=2))
PrEP_plot_3<-means_PrEP%>%filter(PrEP2<1)%>%ggplot(aes_string(x="p1",y="p2",fill=col_list[3]))+geom_tile()+facet_grid(PrEP1~PrEP2,scales="free")+scale_fill_gradientn(limits=lims_means_PrEP, colors=brewer.pal(5,name="RdYlBu"))+xlab("P(HIV|Contact and -PrEP)")+ylab("P(HIV|Contact and PrEP)")+ggtitle("Mean contrast estimate in regenerated PrEP allocation by PrEP coverage")+scale_x_discrete(guide = guide_axis(n.dodge=2))
PrEP_plot_1
PrEP_plot_2
PrEP_plot_3
```

```{r PrEP wrap}
PrEP_plot_1<-means_PrEP%>%filter(PrEP2<1)%>%ggplot(aes_string(x="p1",y="p2",fill=col_list[1]))+geom_tile()+facet_wrap(PrEP1~PrEP2,scales="free", ncol=9, nrow=4)+scale_fill_gradientn(limits=lims_means_PrEP, colors=brewer.pal(5,name="RdYlBu"))+xlab("P(HIV|Contact and -PrEP)")+ylab("P(HIV|Contact and PrEP)")+ggtitle("Contrast Estimate Mean in random PrEP Allocation by PrEP Coverage")+scale_x_discrete(guide = guide_axis(n.dodge=2))
PrEP_plot_2<-means_PrEP%>%filter(PrEP2<1)%>%ggplot(aes_string(x="p1",y="p2",fill=col_list[2]))+geom_tile()+facet_wrap(PrEP1~PrEP2,scales="free",ncol=9, nrow=4)+scale_fill_gradientn(limits=lims_means_PrEP, colors=brewer.pal(5,name="RdYlBu"))+xlab("P(HIV|Contact and -PrEP)")+ylab("P(HIV|Contact and PrEP)")+ggtitle("Contrast Estimate Mean in additive PrEP Allocation by PrEP Coverage")+scale_x_discrete(guide = guide_axis(n.dodge=2))
PrEP_plot_3<-means_PrEP%>%filter(PrEP2<1)%>%ggplot(aes_string(x="p1",y="p2",fill=col_list[3]))+geom_tile()+facet_wrap(PrEP1~PrEP2,scales="free",ncol=9,nrow=4)+scale_fill_gradientn(limits=lims_means_PrEP, colors=brewer.pal(5,name="RdYlBu"))+xlab("P(HIV|Contact and -PrEP)")+ylab("P(HIV|Contact and PrEP)")+ggtitle("Contrast Estimate Mean in regenerated PrEP Allocation by PrEP Coverage")+scale_x_discrete(guide = guide_axis(n.dodge=2))
PrEP_plot_1 & theme(plot.title = element_text(hjust = 0.5))
PrEP_plot_2 & 
  theme(plot.title = element_text(hjust = 0.5))
PrEP_plot_3 & 
  theme(plot.title = element_text(hjust = 0.5))
```


```{r}
# PrEP_ran1<-ggplot(means_PrEP,aes_string(x="p1",y="p2",fill=col_list[1]))+geom_tile()+facet_grid(PrEP2~PrEP1)
# PrEP_ran2<-ggplot(means_PrEP,aes_string(x="p1",y="p2",fill=col_list[2]))+geom_tile()+facet_grid(PrEP1~PrEP2)
# PrEP_regen<-ggplot(means_PrEP,aes_string(x="p1",y="p2",fill=col_list[3]))+geom_tile()+facet_grid(PrEP1~PrEP2)

# PrEP_ran1<-ggplot(means_PrEP,aes_string(x="p1",y="p2",fill=col_list[1]))+geom_tile()+facet_grid(~PrEP1)+scale_fill_gradientn(colors=brewer.pal(5,name="RdYlBu"))
# PrEP_ran2<-ggplot(means_PrEP,aes_string(x="p1",y="p2",fill=col_list[2]))+geom_tile()+facet_grid(~PrEP1)+scale_fill_gradientn(colors=brewer.pal(5,name="RdYlBu"))
# PrEP_regen<-ggplot(means_PrEP,aes_string(x="p1",y="p2",fill=col_list[3]))+geom_tile()+facet_grid(~PrEP1)+scale_fill_gradientn(colors=brewer.pal(5,name="RdYlBu"))

# PrEP_ran1
# PrEP_ran2
# PrEP_regen
#Try ternary plots (using Ternary) [try ggtern?]
# ranBins <- 5
# myran <- viridisLite::viridis(ranBins)
# binnedran <- cut(means_PrEP$ran, ranBins)
# dat_col <- myran[binnedran]
# p2Bins <- 5
# myp2 <- seq(0.5, 2.4, length.out = p2Bins)
# binnedp2 <- cut(means_PrEP$p2, p2Bins)
# dat_cex <- myp2[binnedp2]
# TernaryPlot(atip="PrEP1",btip="PrEP2",ctip="p1", axis.labels = seq(0.1,1, by = 0.1))
# TernaryPoints(means_PrEP[, c("PrEP1", "PrEP2", "p1")],
#               cex = dat_cex,
#               col = dat_col,
#               )
# par(mar=rep(100,4))
# PrEP_ran1<-ggtern(means_PrEP,aes_string(x="p1",y="p2",z="PrEP1", colour="ran",main=paste("PrEP2=", PrEP2, sep="")))+geom_point()+ theme_bw() +scale_colour_gradientn(colors=brewer.pal(5,name="BuPu"))
# PrEP_ran1
# PrEP2s<-levels(as.factor(means_PrEP$PrEP2))
# 
# my_plot_ran<-function(l){
#   means_PrEP%>%filter(PrEP2==l)%>%ggtern(aes_string(x="p1",y="p2",z="PrEP1", colour="ran"))+geom_point() +scale_colour_gradientn(colors=brewer.pal(5,name="BuPu"))+Tarrowlab("increasing p2")+Larrowlab("Increasing p1")+Rarrowlab("Increasing PrEP1")+ labs(title = paste("PrEP2=", l, sep=""))+theme_showarrows()}
# 
# my_plot_add<-function(l){
#    means_PrEP%>%filter(PrEP2==l)%>%ggtern(aes_string(x="p1",y="p2",z="PrEP1", colour="add"))+geom_point() +scale_colour_gradientn(colors=brewer.pal(5,name="BuPu"))+Tarrowlab("increasing p2")+Larrowlab("Increasing p1")+Rarrowlab("Increasing PrEP1")+ labs(title = paste("PrEP2=", l, sep=""))+theme_showarrows()}
# 
# my_plot_regen<-function(l){
#   means_PrEP%>%filter(PrEP2==l)%>%ggtern(aes_string(x="p1",y="p2",z="PrEP1", colour="regen"))+geom_point() +scale_colour_gradientn(colors=brewer.pal(5,name="BuPu"))+Tarrowlab("increasing p2")+Larrowlab("Increasing p1")+Rarrowlab("Increasing PrEP1")+ labs(title = paste("PrEP2=", l, sep=""))+theme_showarrows()}
# ```
# 
# ```{r}
# lapply(PrEP2s,my_plot_ran)
# ```
# 
# ```{r}
# lapply(PrEP2s,my_plot_add)
# ```
# 
# ```{r}
# lapply(PrEP2s,my_plot_regen)
# ```
# 
# ```{r}
# grid.arrange(plotlist_add[1],plotlist_ran[1],plotlist_regen[1])
```


#### Generative model

```{r}
lims_means_model<-c(min(means_model[,col_list]),max(means_model[,col_list]))
model_plot_1<-ggplot(means_model,aes_string(x="p1",y="p2",fill=col_list[1]))+geom_tile()+scale_fill_gradientn(limits=lims_means_model,colors=brewer.pal(10,name="RdYlBu"))+facet_grid(~model)+xlab("P(HIV|Contact and -PrEP)")+ylab("P(HIV|Contact and PrEP)")
model_plot_2<-ggplot(means_model,aes_string(x="p1",y="p2",fill=col_list[2]))+geom_tile()+scale_fill_gradientn(limits=lims_means_model,colors=brewer.pal(10,name="RdYlBu"))+facet_grid(~model)+xlab("P(HIV|Contact and -PrEP)")+ylab("P(HIV|Contact and PrEP)")
model_plot_3<-ggplot(means_model,aes_string(x="p1",y="p2",fill=col_list[3]))+geom_tile()+scale_fill_gradientn(limits=lims_means_model,colors=brewer.pal(10,name="RdYlBu"))+facet_grid(~model)+xlab("P(HIV|Contact and -PrEP)")+ylab("P(HIV|Contact and PrEP)")
 ggsave(plot=model_plot_2/model_plot_1/model_plot_3+plot_annotation(title = "Contrast Estimate Mean by Network Generative Model and Allocation" ) & 
  theme(plot.title = element_text(hjust = 0.5)),
file="Generative Model Mean plots.png", path="Figures")

```


#### ER edge probability

```{r}
lims_means_eprob<-c(min(means_eprob[,col_list]),max(means_eprob[,col_list]))
eprob_plot_1<-ggplot(means_eprob,aes_string(x="p1",y="p2",fill=col_list[1]))+geom_tile()+scale_fill_gradientn(limits=lims_means_eprob,colors=brewer.pal(10,name="RdYlBu"))+facet_grid(~eprob)+xlab("P(HIV|Contact and -PrEP)")+ylab("P(HIV|Contact and PrEP)")+scale_x_discrete(guide = guide_axis(n.dodge=2))
eprob_plot_2<-ggplot(means_eprob,aes_string(x="p1",y="p2",fill=col_list[2]))+geom_tile()+scale_fill_gradientn(limits=lims_means_eprob,colors=brewer.pal(10,name="RdYlBu"))+facet_grid(~eprob)+xlab("P(HIV|Contact and -PrEP)")+ylab("P(HIV|Contact and PrEP)")+scale_x_discrete(guide = guide_axis(n.dodge=2))
eprob_plot_3<-ggplot(means_eprob,aes_string(x="p1",y="p2",fill=col_list[3]))+geom_tile()+scale_fill_gradientn(limits=lims_means_eprob,colors=brewer.pal(10,name="RdYlBu"))+facet_grid(~eprob)+xlab("P(HIV|Contact and -PrEP)")+ylab("P(HIV|Contact and PrEP)")+scale_x_discrete(guide = guide_axis(n.dodge=2))
ggsave(plot=eprob_plot_2/eprob_plot_1/eprob_plot_3+plot_annotation(title = "Contrast Estimate Mean by ER Edge Formation Probability and Allocation" ) & 
  theme(plot.title = element_text(hjust = 0.5)),
file="ER Edge Probability Mean plots.png", path="Figures")
```

#### BA Preferential attachment power

```{r}
lims_means_pow<-c(min(means_pow[,col_list]),max(means_pow[,col_list]))
pow_plot_1<-ggplot(means_pow,aes_string(x="p1",y="p2",fill=col_list[1]))+geom_tile()+scale_fill_gradientn(limits=lims_means_pow,colors=brewer.pal(10,name="RdYlBu"))+facet_grid(~pow)+xlab("P(HIV|Contact and -PrEP)")+ylab("P(HIV|Contact and PrEP)")+scale_x_discrete(guide = guide_axis(n.dodge=2))
pow_plot_2<-ggplot(means_pow,aes_string(x="p1",y="p2",fill=col_list[2]))+geom_tile()+scale_fill_gradientn(limits=lims_means_pow,colors=brewer.pal(10,name="RdYlBu"))+facet_grid(~pow)+xlab("P(HIV|Contact and -PrEP)")+ylab("P(HIV|Contact and PrEP)")+scale_x_discrete(guide = guide_axis(n.dodge=2))
pow_plot_3<-ggplot(means_pow,aes_string(x="p1",y="p2",fill=col_list[3]))+geom_tile()+scale_fill_gradientn(limits=lims_means_pow,colors=brewer.pal(10,name="RdYlBu"))+facet_grid(~pow)+xlab("P(HIV|Contact and -PrEP)")+ylab("P(HIV|Contact and PrEP)")+scale_x_discrete(guide = guide_axis(n.dodge=2))
ggsave(pow_plot_2/pow_plot_1/pow_plot_3 + plot_annotation(title = "Contrast Estimate Mean by BA Preferential Attachment Power and Allocation" ) & 
  theme(plot.title = element_text(hjust = 0.5)),
file="BA Preferential Attachment Power Mean plots.png", path="Figures")
```


#### Small-World neighborhood size

```{r}
lims_means_nb<-c(min(means_nb[,col_list]),max(means_nb[,col_list]))
nb_plot_1<-ggplot(means_nb,aes_string(x="p1",y="p2",fill=col_list[1]))+geom_tile()+scale_fill_gradientn(limits=lims_means_nb,colors=brewer.pal(10,name="RdYlBu"))+facet_grid(~as.numeric(nb))+xlab("P(HIV|Contact and -PrEP)")+ylab("P(HIV|Contact and PrEP)")+scale_x_discrete(guide = guide_axis(n.dodge=2))
nb_plot_2<-ggplot(means_nb,aes_string(x="p1",y="p2",fill=col_list[2]))+geom_tile()+scale_fill_gradientn(limits=lims_means_nb,colors=brewer.pal(10,name="RdYlBu"))+facet_grid(~as.numeric(nb))+xlab("P(HIV|Contact and -PrEP)")+ylab("P(HIV|Contact and PrEP)")+scale_x_discrete(guide = guide_axis(n.dodge=2))
nb_plot_3<-ggplot(means_nb,aes_string(x="p1",y="p2",fill=col_list[3]))+geom_tile()+scale_fill_gradientn(limits=lims_means_nb,colors=brewer.pal(10,name="RdYlBu"))+facet_grid(~as.numeric(nb))+xlab("P(HIV|Contact and -PrEP)")+ylab("P(HIV|Contact and PrEP)")+scale_x_discrete(guide = guide_axis(n.dodge=2))
ggsave(plot=nb_plot_2/nb_plot_1/nb_plot_3+ plot_annotation(title = "Contrast Estimate Mean by WS Neighborhood Size and Allocation" ) & 
  theme(plot.title = element_text(hjust = 0.5)),
file="Small World Neighborhood Size Mean Plots.png",path="Figures")
```


#### Small World Rewiring Probability

```{r}
lims_means_rprob<-c(min(means_rprob[,col_list]),max(means_rprob[,col_list]))
rprob_plot_1<-ggplot(means_rprob,aes_string(x="p1",y="p2",fill=col_list[1]))+geom_tile()+scale_fill_gradientn(limits=lims_means_rprob,colors=brewer.pal(10,name="RdYlBu"))+facet_grid(~rprob)+xlab("P(HIV|Contact and -PrEP)")+ylab("P(HIV|Contact and PrEP)")+scale_x_discrete(guide = guide_axis(n.dodge=2))
rprob_plot_2<-ggplot(means_rprob,aes_string(x="p1",y="p2",fill=col_list[2]))+geom_tile()+scale_fill_gradientn(limits=lims_means_rprob,colors=brewer.pal(10,name="RdYlBu"))+facet_grid(~rprob)+xlab("P(HIV|Contact and -PrEP)")+ylab("P(HIV|Contact and PrEP)")+scale_x_discrete(guide = guide_axis(n.dodge=2))
rprob_plot_3<-ggplot(means_rprob,aes_string(x="p1",y="p2",fill=col_list[3]))+geom_tile()+scale_fill_gradientn(limits=lims_means_rprob,colors=brewer.pal(10,name="RdYlBu"))+facet_grid(~rprob)+xlab("P(HIV|Contact and -PrEP)")+ylab("P(HIV|Contact and PrEP)")+scale_x_discrete(guide = guide_axis(n.dodge=2))
ggsave(plot=rprob_plot_2/rprob_plot_1/rprob_plot_3+ plot_annotation(title = "Contrast Estimate Mean by WS Rewiring Probability and Allocation" ) & 
  theme(plot.title = element_text(hjust = 0.5)),file="Small World Rewiring Probability Mean Plots.png",path="Figures")
```




### Variance plots

#### Network Size

```{r}
lims_var_N<-c(min(var_N[,col_list]),max(var_N[,col_list]))
N_plot_4<-ggplot(var_N,aes_string(x="p1",y="p2", fill=col_list[1]))+geom_tile()+facet_grid(~N)+scale_fill_gradientn(limits=lims_var_N,colors=brewer.pal(6,name="RdYlBu"))+xlab("P(HIV|Contact and -PrEP)")+ylab("P(HIV|Contact and PrEP)")
N_plot_5<-ggplot(var_N,aes_string(x="p1",y="p2", fill=col_list[2]))+geom_tile()+facet_grid(~N)+scale_fill_gradientn(limits=lims_var_N,colors=brewer.pal(6,name="RdYlBu"))+xlab("P(HIV|Contact and -PrEP)")+ylab("P(HIV|Contact and PrEP)")
N_plot_6<-ggplot(var_N,aes_string(x="p1",y="p2", fill=col_list[3]))+geom_tile()+facet_grid(~N)+scale_fill_gradientn(limits=lims_var_N,colors=brewer.pal(6,name="RdYlBu"))+xlab("P(HIV|Contact and -PrEP)")+ylab("P(HIV|Contact and PrEP)")
ggsave(plot=N_plot_5/N_plot_4/N_plot_6+ plot_annotation(title = "Contrast Estimate Variance by Network Size and Allocation" ) & 
  theme(plot.title = element_text(hjust = 0.5)), file="Network Size Variance plots.png", path="Figures")
```

#### Sample Size

```{r}
lims_var_samp<-c(min(var_samp[,col_list]),max(var_samp[,col_list]))
samp_plot_4<-ggplot(var_samp,aes_string(x="p1",y="p2", fill=col_list[1]))+geom_tile()+facet_grid(~nsim)+scale_fill_gradientn(limits=lims_var_samp,colors=brewer.pal(6,name="RdYlBu"))+ylab("P(HIV|Contact and PrEP)")
samp_plot_5<-ggplot(var_samp,aes_string(x="p1",y="p2", fill=col_list[2]))+geom_tile()+facet_grid(~nsim)+scale_fill_gradientn(limits=lims_var_samp,colors=brewer.pal(6,name="RdYlBu"))+xlab("P(HIV|Contact and -PrEP)")+ylab("P(HIV|Contact and PrEP)")
samp_plot_6<-ggplot(var_samp,aes_string(x="p1",y="p2", fill=col_list[3]))+geom_tile()+facet_grid(~nsim)+scale_fill_gradientn(limits=lims_var_samp,colors=brewer.pal(6,name="RdYlBu"))+xlab("P(HIV|Contact and -PrEP)")+ylab("P(HIV|Contact and PrEP)")
ggsave(plot=samp_plot_5/samp_plot_4/samp_plot_6+ plot_annotation(title = "Contrast Estimate Variance by Sample Size and Allocation" ) & 
  theme(plot.title = element_text(hjust = 0.5)), file="Sample Size Variance plots.png", path="Figures")
```

#### HIV Prevalence

```{r}
lims_var_phiv<-c(min(var_phiv[var_phiv$phiv<0.9,col_list]),max(var_phiv[var_phiv$phiv<0.9,col_list]))
phiv_plot_4<-var_phiv%>%filter(phiv<0.9)%>%ggplot(aes_string(x="p1",y="p2",fill=col_list[1]))+geom_tile()+facet_grid(~phiv)+scale_fill_gradientn(limits=lims_var_phiv,n.breaks=10, colors=brewer.pal(10,name="RdYlBu"))+xlab("P(HIV|Contact and -PrEP)")+ylab("P(HIV|Contact and PrEP)")+scale_x_discrete(guide = guide_axis(n.dodge=2))
phiv_plot_5<-var_phiv%>%filter(phiv<0.9)%>%ggplot(aes_string(x="p1",y="p2",fill=col_list[2]))+geom_tile()+facet_grid(~phiv)+scale_fill_gradientn(limits=lims_var_phiv,n.breaks=10,colors=brewer.pal(10,name="RdYlBu"))+xlab("P(HIV|Contact and -PrEP)")+ylab("P(HIV|Contact and PrEP)")+scale_x_discrete(guide = guide_axis(n.dodge=2))
phiv_plot_6<-var_phiv%>%filter(phiv<0.9)%>%ggplot(aes_string(x="p1",y="p2",fill=col_list[3]))+geom_tile()+facet_grid(~phiv)+scale_fill_gradientn(limits=lims_var_phiv,n.breaks=10,colors=brewer.pal(10,name="RdYlBu"))+xlab("P(HIV|Contact and -PrEP)")+ylab("P(HIV|Contact and PrEP)")+scale_x_discrete(guide = guide_axis(n.dodge=2))
ggsave(plot=phiv_plot_5/phiv_plot_4/phiv_plot_6+ plot_annotation(title = "Contrast Estimate Variance by HIV Prevalence and Allocation" ) & 
  theme(plot.title = element_text(hjust = 0.5)), file="HIV Prevalence Variance plots.png", path="Figures/")
```


#### P(HIV|Contact and -PrEP)

```{r}
lims_var_p1<-c(min(var_p1[,col_list]),max(var_p1[,col_list]))
p1_plot_4<-ggplot(var_p1,aes_string(x="p1",y=col_list[1]))+geom_point()+scale_y_continuous(limits=lims_var_p1)+xlab("P(HIV|Contact and -PrEP)")+scale_x_discrete(breaks=seq(0.1,1,0.05))
p1_plot_5<-ggplot(var_p1,aes_string(x="p1",y=col_list[2]))+geom_point()+scale_y_continuous(limits=lims_var_p1)+xlab("P(HIV|Contact and -PrEP)")+scale_x_discrete(breaks=seq(0.1,1,0.05))
p1_plot_6<-ggplot(var_p1,aes_string(x="p1",y=col_list[3]))+geom_point()+scale_y_continuous(limits=lims_var_p1)+xlab("P(HIV|Contact and -PrEP)")+scale_x_discrete(breaks=seq(0.1,1,0.05))
ggsave(plot=p1_plot_5/p1_plot_4/p1_plot_6+ plot_annotation(title = "Contrast Estimate Variance by P(HIV|Contact and -PrEP) and Allocation" ) & 
  theme(plot.title = element_text(hjust = 0.5)), file="p1 Variance plots.png", path="Figures/") 
```

#### P(HIV|Contact and PrEP)

```{r}
lims_var_p2<-c(min(var_p2[,col_list]),max(var_p2[,col_list]))
p2_plot_4<-ggplot(var_p2,aes_string(x="p2",y=col_list[1]))+geom_point()+scale_y_continuous(limits=lims_var_p2)+xlab("P(HIV|Contact and PrEP)")+scale_x_discrete(breaks=seq(0.1,1,0.05))
p2_plot_5<-ggplot(var_p2,aes_string(x="p2",y=col_list[2]))+geom_point()+scale_y_continuous(limits=lims_var_p2)+xlab("P(HIV|Contact and PrEP)")+scale_x_discrete(breaks=seq(0.1,1,0.05))
p2_plot_6<-ggplot(var_p2,aes_string(x="p2",y=col_list[3]))+geom_point()+scale_y_continuous(limits=lims_var_p2)+xlab("P(HIV|Contact and PrEP)")+scale_x_discrete(breaks=seq(0.1,1,0.05))
ggsave(plot=p2_plot_5/p2_plot_4/p2_plot_6+ plot_annotation(title = "Contrast Estimate Variance by P(HIV|Contact and PrEP) and Allocation" )& 
  theme(plot.title = element_text(hjust = 0.5)) , file="p2 Variance plots.png", path="Figures/") 
```


#### PrEP1 and PrEP2

```{r}
lims_var_PrEP<-c(min(var_PrEP[,col_list]),max(var_PrEP[,col_list]))
PrEP_plot_4<-var_PrEP%>%filter(PrEP2<1)%>%ggplot(aes_string(x="p1",y="p2",fill=col_list[1]))+geom_tile()+facet_wrap(PrEP1~PrEP2,scales="free", ncol=9, nrow=4)+scale_fill_gradientn(limits=lims_var_PrEP, colors=brewer.pal(5,name="RdYlBu"))+xlab("P(HIV|Contact and -PrEP)")+ylab("P(HIV|Contact and PrEP)")+ggtitle("Contrast Estimate Variance in random PrEP Allocation by PrEP Coverage")&theme(plot.title = element_text(hjust = 0.5))
PrEP_plot_5<-var_PrEP%>%filter(PrEP2<1)%>%ggplot(aes_string(x="p1",y="p2",fill=col_list[2]))+geom_tile()+facet_wrap(PrEP1~PrEP2,scales="free", ncol=9, nrow=4)+scale_fill_gradientn(limits=lims_var_PrEP, colors=brewer.pal(5,name="RdYlBu"))+xlab("P(HIV|Contact and -PrEP)")+ylab("P(HIV|Contact and PrEP)")+ggtitle("Contrast Estimate Variance in additive PrEP Allocation by PrEP Coverage")&theme(plot.title = element_text(hjust = 0.5))
PrEP_plot_6<-var_PrEP%>%filter(PrEP2<1)%>%ggplot(aes_string(x="p1",y="p2",fill=col_list[3]))+geom_tile()+facet_wrap(PrEP1~PrEP2,scales="free", ncol=9, nrow=4)+scale_fill_gradientn(limits=lims_var_PrEP, colors=brewer.pal(5,name="RdYlBu"))+xlab("P(HIV|Contact and -PrEP)")+ylab("P(HIV|Contact and PrEP)")+ggtitle("Contrast Estimate Variance in regenerated PrEP Allocation by PrEP Coverage")&theme(plot.title = element_text(hjust = 0.5))
PrEP_plot_4
PrEP_plot_5
PrEP_plot_6
```



#### Generative Model

```{r}
lims_var_model<-c(min(var_model[,col_list]),max(var_model[,col_list]))
model_plot_4<-ggplot(var_model,aes_string(x="p1",y="p2",fill=col_list[1]))+geom_tile()+scale_fill_gradientn(limits=lims_var_model,colors=brewer.pal(10,name="RdYlBu"))+facet_grid(~model)+xlab("P(HIV|Contact and -PrEP)")+ylab("P(HIV|Contact and PrEP)")
model_plot_5<-ggplot(var_model,aes_string(x="p1",y="p2",fill=col_list[2]))+geom_tile()+scale_fill_gradientn(limits=lims_var_model,colors=brewer.pal(10,name="RdYlBu"))+facet_grid(~model)+xlab("P(HIV|Contact and -PrEP)")+ylab("P(HIV|Contact and PrEP)")
model_plot_6<-ggplot(var_model,aes_string(x="p1",y="p2",fill=col_list[3]))+geom_tile()+scale_fill_gradientn(limits=lims_var_model,colors=brewer.pal(10,name="RdYlBu"))+facet_grid(~model)+xlab("P(HIV|Contact and -PrEP)")+ylab("P(HIV|Contact and PrEP)")
ggsave(model_plot_5/model_plot_4/model_plot_6+    # Create grid of plots with title
  plot_annotation(title = "Contrast Estimate Variance by Network Generative Model and Allocation") & 
  theme(plot.title = element_text(hjust = 0.5)), file="Generative Model Variance plots.png",path = "Figures/")

```


#### ER edge probability

```{r}
lims_var_eprob<-c(min(var_eprob[,col_list]),max(var_eprob[,col_list]))
eprob_plot_4<-ggplot(var_eprob,aes_string(x="p1",y="p2",fill=col_list[1]))+geom_tile()+scale_fill_gradientn(limits=lims_var_eprob,colors=brewer.pal(10,name="RdYlBu"))+facet_grid(~eprob)+xlab("P(HIV|Contact and -PrEP)")+ylab("P(HIV|Contact and PrEP)")
eprob_plot_5<-ggplot(var_eprob,aes_string(x="p1",y="p2",fill=col_list[2]))+geom_tile()+scale_fill_gradientn(limits=lims_var_eprob,colors=brewer.pal(10,name="RdYlBu"))+facet_grid(~eprob)+xlab("P(HIV|Contact and -PrEP)")+ylab("P(HIV|Contact and PrEP)")
eprob_plot_6<-ggplot(var_eprob,aes_string(x="p1",y="p2",fill=col_list[3]))+geom_tile()+scale_fill_gradientn(limits=lims_var_eprob,colors=brewer.pal(10,name="RdYlBu"))+facet_grid(~eprob)+xlab("P(HIV|Contact and -PrEP)")+ylab("P(HIV|Contact and PrEP)")
ggsave(eprob_plot_5/eprob_plot_4/eprob_plot_6+    # Create grid of plots with title
         plot_annotation(title = "Contrast Estimate Variance in ER model by Edge Probability and Allocation") & 
  theme(plot.title = element_text(hjust = 0.5)),file="ER Edge Probability Variance Plots.png",path="Figures/")
```


#### BA Preferential attachment power

```{r}
lims_var_pow<-c(min(var_pow[,col_list]),max(var_pow[,col_list]))
pow_plot_4<-ggplot(var_pow,aes_string(x="p1",y="p2",fill=col_list[1]))+geom_tile()+scale_fill_gradientn(limits=lims_var_pow,colors=brewer.pal(10,name="RdYlBu"))+facet_grid(~pow)+xlab("P(HIV|Contact and -PrEP)")+ylab("P(HIV|Contact and PrEP)")+scale_x_discrete(guide = guide_axis(n.dodge=2))
pow_plot_5<-ggplot(var_pow,aes_string(x="p1",y="p2",fill=col_list[2]))+geom_tile()+scale_fill_gradientn(limits=lims_var_pow,colors=brewer.pal(10,name="RdYlBu"))+facet_grid(~pow)+xlab("P(HIV|Contact and -PrEP)")+ylab("P(HIV|Contact and PrEP)")+scale_x_discrete(guide = guide_axis(n.dodge=2))
pow_plot_6<-ggplot(var_pow,aes_string(x="p1",y="p2",fill=col_list[3]))+geom_tile()+scale_fill_gradientn(limits=lims_var_pow,colors=brewer.pal(10,name="RdYlBu"))+facet_grid(~pow)+xlab("P(HIV|Contact and -PrEP)")+ylab("P(HIV|Contact and PrEP)")+scale_x_discrete(guide = guide_axis(n.dodge=2))
ggsave(plot=pow_plot_5/pow_plot_4/pow_plot_6+    # Create grid of plots with title
  plot_annotation(title = "Contrast Estimate Variance in BA model by Preferential Attachment Power and Allocation") &
  theme(plot.title = element_text(hjust = 0.5)), file="BA Preferential attachment power Variance plots.png",path="Figures/", units = "px", width=1890, height=900)
```

#### Small World neighborhood size

```{r}
lims_var_nb<-c(min(var_nb[,col_list]),max(var_nb[,col_list]))
nb_plot_4<-ggplot(var_nb,aes_string(x="p1",y="p2",fill=col_list[1]))+geom_tile()+scale_fill_gradientn(limits=lims_var_nb,colors=brewer.pal(10,name="RdYlBu"))+facet_grid(~as.numeric(nb))+xlab("P(HIV|Contact and -PrEP)")+ylab("P(HIV|Contact and PrEP)")+scale_x_discrete(guide = guide_axis(n.dodge=2))
nb_plot_5<-ggplot(var_nb,aes_string(x="p1",y="p2",fill=col_list[2]))+geom_tile()+scale_fill_gradientn(limits=lims_var_nb,colors=brewer.pal(10,name="RdYlBu"))+facet_grid(~as.numeric(nb))+xlab("P(HIV|Contact and -PrEP)")+ylab("P(HIV|Contact and PrEP)")+scale_x_discrete(guide = guide_axis(n.dodge=2))
nb_plot_6<-ggplot(var_nb,aes_string(x="p1",y="p2",fill=col_list[3]))+geom_tile()+scale_fill_gradientn(limits=lims_var_nb,colors=brewer.pal(10,name="RdYlBu"))+facet_grid(~as.numeric(nb))+xlab("P(HIV|Contact and -PrEP)")+ylab("P(HIV|Contact and PrEP)")+scale_x_discrete(guide = guide_axis(n.dodge=2))
ggsave(plot=nb_plot_5/nb_plot_4/nb_plot_6+    # Create grid of plots with title
  plot_annotation(title = "Contrast Estimate Variance in WS model by neighborhood size and Allocation") & 
  theme(plot.title = element_text(hjust = 0.5)),file="Small World neighborhood size Variance Plots.png",path="Figures/")
```

#### Small World rewiring probability

```{r}
lims_var_rprob<-c(min(var_rprob[,col_list]),max(var_rprob[,col_list]))
rprob_plot_4<-ggplot(var_rprob,aes_string(x="p1",y="p2",fill=col_list[1]))+geom_tile()+scale_fill_gradientn(limits=lims_var_rprob,colors=brewer.pal(10,name="RdYlBu"))+facet_grid(~rprob)+xlab("P(HIV|Contact and -PrEP)")+ylab("P(HIV|Contact and PrEP)")+scale_x_discrete(guide = guide_axis(n.dodge=2))
rprob_plot_5<-ggplot(var_rprob,aes_string(x="p1",y="p2",fill=col_list[2]))+geom_tile()+scale_fill_gradientn(limits=lims_var_rprob,colors=brewer.pal(10,name="RdYlBu"))+facet_grid(~rprob)+xlab("P(HIV|Contact and -PrEP)")+ylab("P(HIV|Contact and PrEP)")+scale_x_discrete(guide = guide_axis(n.dodge=2))
rprob_plot_6<-ggplot(var_rprob,aes_string(x="p1",y="p2",fill=col_list[3]))+geom_tile()+scale_fill_gradientn(limits=lims_var_rprob,colors=brewer.pal(10,name="RdYlBu"))+facet_grid(~rprob)+xlab("P(HIV|Contact and -PrEP)")+ylab("P(HIV|Contact and PrEP)")+scale_x_discrete(guide = guide_axis(n.dodge=2))
ggsave(rprob_plot_5/rprob_plot_4/rprob_plot_6 +    # Create grid of plots with title
  plot_annotation(title = "Contrast Estimate Variance in WS model by Rewiring Probability and Allocation") & 
  theme(plot.title = element_text(hjust = 0.5)), file="Small World rewiring probability Variance Plots.png",path="Figures")
```



### Network summary statistics-version 1

```{r}
model_plot_7<-ggboxplot(res_model,x="model",y=c("Number of Components g","Number of Components k"),ylab=F, merge = T)
model_plot_8<-ggboxplot(res_model,x="model",y=c("Largest Component Size g","Largest Component Size k"),ylab=F,merge=T)
model_plot_9<-ggboxplot(res_model,x="model", y=c("Avg. Betweenness g","Avg. Betweenness k"),ylab=F,merge=T)
model_plot_10<-ggboxplot(res_model,x="model",y=c("Density g","Density k"),ylab=F, merge = T)
model_plot_11<-ggboxplot(res_model,x="model",y=c("Degree Centralization g","Degree Centralization k"),ylab=F, merge = T)
model_plot_12<-ggboxplot(res_model,x="model",y=c("Avg. Geodesic Distance g","Avg. Geodesic Distance k"),ylab=F, merge = T)
model_plot_13<-ggboxplot(res_model,x="model",y=c("Diameter g","Diameter k"),ylab=F, merge = T)
model_plot_14<-ggboxplot(res_model,x="model",y=c("Transitivity g","Transitivity k"),ylab=F,merge=T)
model_plot_15<-ggboxplot(res_model,x="model",y=c("Proportion of nodes in 2-cores g","Proportion of nodes in 2-cores k"),ylab=F,merge=T)
model_plot_16<-ggboxplot(res_model,x="model",y=c("Degree Assortativity g","Degree Assortativity k"),ylab=F,merge=T)
ggsave(model_plot_7+model_plot_8+model_plot_9+model_plot_10+model_plot_12+model_plot_13+model_plot_14+model_plot_15+    # Create grid of plots with title
  plot_annotation(title = "Network Summary Statistics by Generative Model and Allocation") & 
  theme(plot.title = element_text(hjust = 0.5)), file="Network Summary Statistics.png",path="Figures")
```
