---
title: "Network Simulation Models"
output: html_document
date: '2022-07-18'
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Libraries

```{r libraries}
require("EpiModel")
require("igraph")
# require("foreach")
# require("doParallel")
require("reticulate")
require(dplyr)
require(ggplot2)
require(desplot)
require(patchwork)
require(purrr)
require(furrr)
require(tidyverse)
require(RColorBrewer)
# require(gganimate)
# require(Ternary)
require(ggtern)
require(ggforce)
# plan("multisession", workers=24)
set.seed(500)
options(future.rng.onMisuse="ignore")
```

## Parameters

```{r params}
N<-50 #network population/ graph order
eprob<-0.1 #edge formation probability for ER model 
phiv<-0.1 # underlying hiv prevalence
PrEP1<-0.2 # PrEP assignment coverage in control treatment (a) 
PrEP2<-0.4 # PrEP assignment coverage in counterfactual treatment (a*)
#HIV risk by contact and PrEP allocation p
p1<-0.2 #P(HIV|Contact and -PrEP)
p2<-0.1 #P(HIV|Contact and PrEP)
nsim<-100
plots=T
scale="additive"
```

## Simulation Function

```{r simulation}
sim<-function(N=20,eprob=0.1,phiv=0.1,PrEP1=0.1,PrEP2=0.2, p1=0.2,p2=0.1, plots=F, scale="additive"){
  #parameter check
# plot a random graph, 3 color options
#control scenario graph, 10% assignment prob
g <- sample_gnp(N,eprob)
l_hiv_g<-round((gorder(g)*phiv),0)
l_PrEP1_g<-round(((gorder(g)-l_hiv_g)*PrEP1),0)
l_sus_g<-round((gorder(g)-(l_hiv_g+l_PrEP1_g)),0)
vertex_attr(g) <- list(color=c(rep("red", l_hiv_g), rep("blue",l_PrEP1_g), rep("black",l_sus_g)))
if(plots){plot(g, vertex.size=10,vertex.label.cex=1, vertex.label.dist=2,main="Control",layout=layout_nicely(g))}
inf_contact_g<-setdiff(unlist(adjacent_vertices(g,v=V(g)[color=="red"])), V(g)[color=="red"])
#compute P(HIV|PrEP)
treat_g<-V(g)[V(g)$color=="blue"]
treat_inf_contact_g<- V(g)[inf_contact_g][which(V(g)[inf_contact_g]$color=="blue")]
g<-set_vertex_attr(g,name="color",index=inf_contact_g,value="orange")
g<-set_vertex_attr(g, name="color",index=treat_inf_contact_g,value="purple")
if(plots){plot(g, vertex.size=10,vertex.label.cex=1, vertex.label.dist=2,main="Control",layout=layout_nicely(g))}
inf_contact_g<-setdiff(unlist(adjacent_vertices(g,v=V(g)[color=="red"])), V(g)[color=="red"])
hiv_given_prep_g<-ifelse(length(treat_g)!=0,(length(treat_inf_contact_g)*p2)/length(treat_g),0)
#Compute P(HIV|-PrEP)
no_treat_g<-V(g)[V(g)$color %in% c("black","orange")]
no_treat_inf_contact_g<-V(g)[V(g)$color=="orange"]
hiv_given_no_prep_g<-ifelse(length(no_treat_g)!=0,(length(no_treat_inf_contact_g)*p1)/length(no_treat_g),0)
#Randomly assign 20% overall (shuffle attributes)
l_hiv_h<-round((gorder(g)*phiv),0)
l_PrEP2_h<-round(((gorder(g)-l_hiv_h)*PrEP2),0)
l_sus_h<-round((gorder(g)-(l_hiv_h+l_PrEP2_h)),0)
h<-set_vertex_attr(g,"color",value=c(rep("red",l_hiv_h), sample(c(rep("blue",l_PrEP2_h), rep("black", l_sus_h)))))
if(plots){plot(h,vertex.size=10,vertex.label.cex=1, vertex.label.dist=2,main="Random overall", layout=layout_nicely(h))}
inf_contact_h<-setdiff(unlist(adjacent_vertices(h,v=V(h)[color=="red"])), V(h)[color=="red"])
#Compute P(HIV|PrEP)
treat_h<-V(h)[V(h)$color=="blue"]
treat_inf_contact_h<-V(h)[inf_contact_h][which(V(h)[inf_contact_h]$color=="blue")]
h<-set_vertex_attr(h,name="color",index=inf_contact_h,value="orange")
h<-set_vertex_attr(h, name="color",index=treat_inf_contact_h,value="purple")
hiv_given_prep_h<-ifelse(length(treat_h)!=0,(length(treat_inf_contact_h)*p2)/length(treat_h),0)
#Compute P(HIV|-PrEP)
no_treat_h<-V(h)[V(h)$color%in% c("black","orange")]
no_treat_inf_contact_h<-V(h)[V(h)$color=="orange"]
hiv_given_no_prep_h<-ifelse(length(no_treat_h)!=0,(length(no_treat_inf_contact_h)*p1)/length(no_treat_h),0)
#duplicate network structure, additional 10% treated
l_hiv_j<-round((gorder(g)*phiv),0)
l_PrEP2_j<-round(((gorder(g)-l_hiv_j)*PrEP2),0)
l_sus_j<-round((gorder(g)-(l_hiv_j+l_PrEP2_j)),0)
j<-set_vertex_attr(g,"color",value=c(rep("red", l_hiv_j), rep("blue",l_PrEP2_j), rep("black", l_sus_j)))
if(plots){plot(j,  vertex.size=10,vertex.label.cex=1, vertex.label.dist=2,main="Random additional", layout=layout_nicely(j))}
inf_contact_j<-setdiff(unlist(adjacent_vertices(j,v=V(j)[color=="red"])), V(j)[color=="red"])
#compute (HIV|PrEP)
treat_j<-V(j)[V(j)$color=="blue"]
treat_inf_contact_j<-V(j)[inf_contact_j][which(V(j)[inf_contact_j]$color=="blue")]
j<-set_vertex_attr(j,name="color",index=inf_contact_j,value="orange")
j<-set_vertex_attr(j, name="color",index=treat_inf_contact_j,value="purple")
hiv_given_prep_j<-ifelse(length(treat_j)!=0,(length(treat_inf_contact_j)*p2)/length(treat_j),0)
#Compute P(HIV|-PrEP)
no_treat_j<-V(j)[V(j)$color%in% c("black","orange")]
no_treat_inf_contact_j<-V(j)[V(j)$color=="orange"]
hiv_given_no_prep_j<-ifelse(length(no_treat_j)!=0,(length(no_treat_inf_contact_j)*p1)/length(no_treat_j),0)
# plot a random graph, 3 color options
k <- sample_gnp(N,eprob)
l_hiv_k<-round((gorder(k)*phiv),0)
l_PrEP2_k<-round(((gorder(k)-l_hiv_k)*PrEP2),0)
l_sus_k<-round((gorder(k)-(l_hiv_k+l_PrEP2_k)),0)
vertex_attr(k) <- list(color =c(rep("red", l_hiv_k), rep("blue",l_PrEP2_k), rep("black", l_sus_k)))
if(plots){plot(k,  vertex.size=10,vertex.label.cex=1, vertex.label.dist=2,main="Regenerated", layout=layout_nicely(k))}
inf_contact_k<-setdiff(unlist(adjacent_vertices(k,v=V(k)[color=="red"])), V(k)[color=="red"])
#Compute P(HIV|PrEP)
treat_k<-V(k)[V(k)$color=="blue"]
treat_inf_contact_k<-V(k)[inf_contact_k][which(V(k)[inf_contact_k]$color=="blue")]
k<-set_vertex_attr(k,name="color",index=inf_contact_k,value="orange")
k<-set_vertex_attr(k, name="color",index=treat_inf_contact_k,value="purple")
hiv_given_prep_k<-ifelse(length(treat_k)!=0,(length(treat_inf_contact_k)*p2)/length(treat_k),0)
#Compute P(HIV|-PrEP)
no_treat_k<-V(k)[V(k)$color%in% c("black","orange")]
no_treat_inf_contact_k<-V(h)[V(h)$color=="orange"]
hiv_given_no_prep_k<-ifelse(length(no_treat_k)!=0,(length(no_treat_inf_contact_k)*p1)/length(no_treat_k),0)
# Combine effect estimates
prep<-c(hiv_given_prep_g,hiv_given_prep_h,hiv_given_prep_j,hiv_given_prep_k)
names(prep)<-c("hiv_given_prep_g","hiv_given_prep_h","hiv_given_prep_j","hiv_given_prep_k")
no_prep<-c(hiv_given_no_prep_g,hiv_given_no_prep_h,hiv_given_no_prep_j,hiv_given_no_prep_k)
names(no_prep)<-c("hiv_given_no_prep_g","hiv_given_no_prep_h","hiv_given_no_prep_j","hiv_given_no_prep_k")
ef<-prep+no_prep
names(ef)<-c("control,","ran","add","regen")
#compute causal contrasts
if(scale=="additive"){cc<-as.data.frame(t(ef[-1]-ef[1]))}
# else if(scale=="multiplicative"){ef<-ef+1;
# cc<-as.data.frame(t(ef[-1])/ef[1]); 
#if(is.na(t(ef[-1]/ef[1]))||is.infinite(t(ef[-1]/ef[1]))){print(ef)}
# }
names(cc)<-c("ran","add","regen")
res<-cbind(N,eprob,phiv,PrEP1,PrEP2,p1,p2,as.data.frame(t(prep)),as.data.frame(t(no_prep)),cc)
names(res)<-c("N","eprob","phiv", "PrEP1","PrEP2","p1","p2",names(prep), names(no_prep),names(cc))
return(res)
}
```

## Parallel resampling

```{r simulation parallel}
sim_par<-function(N=20,eprob=0.1,phiv=0.1,PrEP1=0.1,PrEP2=0.2, p1=0.2,p2=0.1, nsim=100, scale="additive"){
res<-future_map_dfr(1:nsim,~sim(N=N,eprob=eprob,phiv=phiv,PrEP1=PrEP1,PrEP2=PrEP2, p1=p1,p2=p2, scale=scale))
res<-cbind(res,nsim)
return(res)}
```

Trying to parallellize sim rather than use simpar, use rerun from purrr?
Don't use rerun, use a map with sim_par?

```{r}
col_list=c("ran","add","regen")
```


## Results 

Check sensitivity to network size, plot heatmap by N

```{r}
params_N<-tidyr::expand_grid(N=c(20,200),phiv=phiv,PrEP1=PrEP1,PrEP2=PrEP2,p1=seq(0.1,1,0.1),p2=seq(0.1,1,0.1), nsim=nsim, scale="additive")
future::plan(
      list(
        future::tweak(
          future::multisession, 
          workers = 2), 
        future::tweak(
          future::multisession,
          workers = 12)
        )
      )
res_N<-future_pmap_dfr(params_N,sim_par)
means_N<-res_N%>%group_by(N,p1,p2)%>%summarise(across(all_of(col_list),mean))
var_N<-res_N%>%group_by(N,p1,p2)%>%summarise(across(all_of(col_list),var))
```

### Figures

#### Mean plots

```{r}
N_plot_1<-ggplot(means_N,aes_string(x="p1",y="p2", fill=col_list[1]))+geom_tile()+facet_grid(~N)+scale_fill_gradientn(colors=brewer.pal(5,name="RdYlBu"))
N_plot_2<-ggplot(means_N,aes_string(x="p1",y="p2", fill=col_list[2]))+geom_tile()+facet_grid(~N)+scale_fill_gradientn(colors=brewer.pal(5,name="RdYlBu"))
N_plot_3<-ggplot(means_N,aes_string(x="p1",y="p2", fill=col_list[3]))+geom_tile()+facet_grid(~N)+scale_fill_gradientn(colors=brewer.pal(5,name="RdYlBu"))
N_plot1/N_plot2/N_plot3
```

```{r}
N_plot_1
N_plot_2
N_plot_3
```

#### Variance plots

```{r}
N_plot_4<-ggplot(var_N,aes_string(x="p1",y="p2", fill=col_list[1]))+geom_tile()+facet_grid(~N)+scale_fill_gradientn(colors=brewer.pal(5,name="RdYlBu"))
N_plot_5<-ggplot(var_N,aes_string(x="p1",y="p2", fill=col_list[2]))+geom_tile()+facet_grid(~N)+scale_fill_gradientn(colors=brewer.pal(5,name="RdYlBu"))
N_plot_6<-ggplot(var_N,aes_string(x="p1",y="p2", fill=col_list[3]))+geom_tile()+facet_grid(~N)+scale_fill_gradientn(colors=brewer.pal(5,name="RdYlBu"))
N_plot_4/N_plot_5/N_plot_6
```




check sensitivity to sample size-cluster?

```{r}
params_samp<-expand.grid(N=20,phiv=phiv,PrEP1=PrEP1,PrEP2=PrEP2,p1=seq(0.1,1,0.1),p2=seq(0.1,1,0.1),nsim=10^seq(2,4,1))
future::plan(
      list(
        future::tweak(
          future::multisession, 
          workers = 4), 
        future::tweak(
          future::multisession,
          workers = 6)
        )
      )
system.time(res_samp<-future_pmap_dfr(params_samp,sim_par))
means_samp<-res_samp%>%group_by(nsim,p1,p2)%>%summarise(across(col_list,mean))
var_samp<-res_samp%>%group_by(nsim,p1,p2)%>%summarise(across(col_list,var))
beepr::beep(8)
```

```{r}
samp_plot_1<-ggplot(means_samp,aes_string(x="p1",y="p2",fill=col_list[1]))+geom_tile()+facet_grid(~nsim)+scale_fill_gradientn(colors=brewer.pal(5,name="RdYlBu"))
samp_plot_2<-ggplot(means_samp,aes_string(x="p1",y="p2",fill=col_list[2]))+geom_tile()+facet_grid(~nsim)+scale_fill_gradientn(colors=brewer.pal(5,name="RdYlBu"))
samp_plot_3<-ggplot(means_samp,aes_string(x="p1",y="p2",fill=col_list[3]))+geom_tile()+facet_grid(~nsim)+scale_fill_gradientn(colors=brewer.pal(5,name="RdYlBu"))
```

```{r}
samp_plot_1/samp_plot_2/samp_plot_3
```

increase underlying HIV prevalence phiv

```{r}

params_phiv<-expand.grid(N=20,phiv=seq(0.1,1,0.1),PrEP1=PrEP1,PrEP2=PrEP2,p1=seq(0.1,1,0.1),p2=seq(0.1,1,0.1),nsim=200)
future::plan(
      list(
        future::tweak(
          future::multisession, 
          workers = 3), 
        future::tweak(
          future::multisession,
          workers = 8)
        )
      )
res_phiv<-future_pmap_dfr(params_phiv,sim_par)
means_phiv<-res_phiv%>%group_by(across(all_of(c("phiv","p1","p2"))))%>%summarise(across(col_list,mean))
var_phiv<-res_phiv%>%group_by(across(all_of(c("phiv","p1","p2"))))%>%summarise(across(col_list,var))
beepr::beep(8)
```

```{r}
phiv_plot_1<-ggplot(means_phiv,aes_string(x="p1",y="p2",fill=col_list[1]))+geom_tile()+facet_grid(~phiv)+scale_fill_gradientn(colors=brewer.pal(5,name="RdYlBu"))
phiv_plot_2<-ggplot(means_phiv,aes_string(x="p1",y="p2",fill=col_list[2]))+geom_tile()+facet_grid(~phiv)+scale_fill_gradientn(colors=brewer.pal(5,name="RdYlBu"))
phiv_plot_3<-ggplot(means_phiv,aes_string(x="p1",y="p2",fill=col_list[3]))+geom_tile()+facet_grid(~phiv)+scale_fill_gradientn(colors=brewer.pal(5,name="RdYlBu"))
# phiv_ran1+scale_fill_gradientn(colors=brewer.pal(5,name="RdYlBu"))
phiv_plot_1/phiv_plot_2/phiv_plot_3
```

```{r}
phiv_plot_4<-means_phiv%>%filter(phiv<0.9)%>%ggplot(aes_string(x="p1",y="p2",fill=col_list[1]))+geom_tile()+facet_grid(~phiv)+scale_fill_gradientn(colors=brewer.pal(5,name="RdYlBu"))
phiv_plot_4
```

Increasing p1 only

```{r}
params_p1<-expand_grid(N=20,phiv=0.1,PrEP1=PrEP1,PrEP2=PrEP2,p1=seq(0.1,1,0.01),p2=0.1,nsim=200)
future::plan(
      list(
        future::tweak(
          future::multisession, 
          workers = 2), 
        future::tweak(
          future::multisession,
          workers = 12)
        )
      )
res_p1<-future_pmap_dfr(params_p1,sim_par)
means_p1<-res_p1%>%group_by(p1,p2)%>%summarise(across(col_list,mean))
var_p1<-res_p1%>%group_by(p1,p2)%>%summarise(across(col_list,var))
```


```{r}
p1_plot_1<-ggplot(means_p1,aes_string(x="p1",y=col_list[1]))+geom_point()#+scale_y_continuous(limits=c(-0.5,0.5))
p1_plot_2<-ggplot(means_p1,aes_string(x="p1",y=col_list[2]))+geom_point()#+scale_y_continuous(limits=c(-1,1))
p1_plot_3<-ggplot(means_p1,aes_string(x="p1",y=col_list[3]))+geom_point()#+scale_y_continuous(limits=c(-1,1))
```

```{r}
p1_plot_1/p1_plot_2/p1_plot_3
p1_plot_1
p1_plot_2
p1_plot_3
```

Increasing p2 only

```{r}
params_p2<-expand_grid(N=20,phiv=0.1,PrEP1=PrEP1,PrEP2=PrEP2,p2=seq(0.1,1,0.01),p1=0.1,nsim=200)
res_p2<-future_pmap_dfr(params_p2,sim_par)
means_p2<-res_p2%>%group_by(p2,p1)%>%summarise(across(col_list,mean))
var_p2<-res_p2%>%group_by(p2,p1)%>%summarise(across(col_list,var))
```

```{r}
p2_plot_1<-ggplot(means_p2,aes_string(x="p2",y=col_list[1]))+geom_point()#+scale_y_continuous(limits=c(-0.5,0.5))
p2_plot_2<-ggplot(means_p2,aes_string(x="p2",y=col_list[2]))+geom_point()#+scale_y_continuous(limits=c(-1,1))
p2_plot_3<-ggplot(means_p2,aes_string(x="p2",y=col_list[3]))+geom_point()#+scale_y_continuous(limits=c(-1,1))
```

```{r}
p2_plot_1/p2_plot_2/p2_plot_3
```


Increasing PrEP1 and PrEP2
```{r}
params_PrEP<-expand_grid(N=20,phiv=0.1,PrEP1=seq(0.1,1,0.1),PrEP2=seq(0.1,1,0.1),p1=seq(0.1,1,0.1),p2=seq(0.1,1,0.1),nsim=200)%>%filter(PrEP2>PrEP1)
# plan(multisession(workers = availableCores()))
# future::plan(
#       list(
#         future::tweak(
#           future::multisession, 
#           workers = 4), 
#         future::tweak(
#           future::multisession,
#           workers = 6)
#         )
#       )

system.time(res_PrEP<-future_pmap_dfr(params_PrEP,sim_par))
beepr::beep(8)
means_PrEP<-res_PrEP%>%group_by(across(all_of(c("PrEP1","PrEP2","p1","p2"))))%>%summarise(across(col_list,mean), .groups = "keep")
var_PrEP<-res_PrEP%>%group_by(across(all_of(c("PrEP1","PrEP2","p1","p2"))))%>%summarise(across(col_list,var), .groups = "keep")
```

```{r}
# PrEP_ran1<-ggplot(means_PrEP,aes_string(x="p1",y="p2",fill=col_list[1]))+geom_tile()+facet_grid(PrEP2~PrEP1)
# # +facet_wrap(PrEP1~PrEP2)
# PrEP_ran2<-ggplot(means_PrEP,aes_string(x="p1",y="p2",fill=col_list[2]))+geom_tile()+facet_grid(PrEP1~PrEP2)
# PrEP_regen<-ggplot(means_PrEP,aes_string(x="p1",y="p2",fill=col_list[3]))+geom_tile()+facet_grid(PrEP1~PrEP2)
```




```{r}
# PrEP_ran1<-ggplot(means_PrEP,aes_string(x="p1",y="p2",fill=col_list[1]))+geom_tile()+facet_grid(~PrEP1)+scale_fill_gradientn(colors=brewer.pal(5,name="RdYlBu"))
# PrEP_ran2<-ggplot(means_PrEP,aes_string(x="p1",y="p2",fill=col_list[2]))+geom_tile()+facet_grid(~PrEP1)+scale_fill_gradientn(colors=brewer.pal(5,name="RdYlBu"))
# PrEP_regen<-ggplot(means_PrEP,aes_string(x="p1",y="p2",fill=col_list[3]))+geom_tile()+facet_grid(~PrEP1)+scale_fill_gradientn(colors=brewer.pal(5,name="RdYlBu"))
```

```{r}
# PrEP_ran1
# PrEP_ran2
# PrEP_regen
```


Try ternary plots (using Ternary) [try ggtern?]
```{r}
# ranBins <- 5
# myran <- viridisLite::viridis(ranBins)
# binnedran <- cut(means_PrEP$ran, ranBins)
# dat_col <- myran[binnedran]
# p2Bins <- 5
# myp2 <- seq(0.5, 2.4, length.out = p2Bins)
# binnedp2 <- cut(means_PrEP$p2, p2Bins)
# dat_cex <- myp2[binnedp2]
# TernaryPlot(atip="PrEP1",btip="PrEP2",ctip="p1", axis.labels = seq(0.1,1, by = 0.1))
# TernaryPoints(means_PrEP[, c("PrEP1", "PrEP2", "p1")],
#               cex = dat_cex,
#               col = dat_col,
#               )
```

```{r}
# par(mar=rep(100,4))
# PrEP_ran1<-ggtern(means_PrEP,aes_string(x="p1",y="p2",z="PrEP1", colour="ran",main=paste("PrEP2=", PrEP2, sep="")))+geom_point()+ theme_bw() +scale_colour_gradientn(colors=brewer.pal(5,name="BuPu"))
# PrEP_ran1
PrEP2s<-levels(as.factor(means_PrEP$PrEP2))

my_plot_ran<-function(l){
  means_PrEP%>%filter(PrEP2==l)%>%ggtern(aes_string(x="p1",y="p2",z="PrEP1", colour="ran"))+geom_point() +scale_colour_gradientn(colors=brewer.pal(5,name="BuPu"))+Tarrowlab("increasing p2")+Larrowlab("Increasing p1")+Rarrowlab("Increasing PrEP1")+ labs(title = paste("PrEP2=", l, sep=""))+theme_showarrows()}

my_plot_add<-function(l){
   means_PrEP%>%filter(PrEP2==l)%>%ggtern(aes_string(x="p1",y="p2",z="PrEP1", colour="add"))+geom_point() +scale_colour_gradientn(colors=brewer.pal(5,name="BuPu"))+Tarrowlab("increasing p2")+Larrowlab("Increasing p1")+Rarrowlab("Increasing PrEP1")+ labs(title = paste("PrEP2=", l, sep=""))+theme_showarrows()}

my_plot_regen<-function(l){
  means_PrEP%>%filter(PrEP2==l)%>%ggtern(aes_string(x="p1",y="p2",z="PrEP1", colour="regen"))+geom_point() +scale_colour_gradientn(colors=brewer.pal(5,name="BuPu"))+Tarrowlab("increasing p2")+Larrowlab("Increasing p1")+Rarrowlab("Increasing PrEP1")+ labs(title = paste("PrEP2=", l, sep=""))+theme_showarrows()}
```

```{r}
lapply(PrEP2s,my_plot_ran)
```

```{r}
lapply(PrEP2s,my_plot_add)
```

```{r}
lapply(PrEP2s,my_plot_regen)
```

```{r}
grid.arrange(plotlist_add[1],plotlist_ran[1],plotlist_regen[1])
```



Below are failed attempts at parallelization DO NOT USE
```{r}
# # #sweep p1 only
# res3<-foreach(p1=seq(0.1,1,0.1) ) %:% foreach(icount(nsim), .combine=rbind) %dopar% {sim(N=N,eprob=eprob,phiv=phiv,PrEP1=PrEP1,PrEP2=PrEP2, p1=p1,p2=p2)}
# # #sweep p2 only
# res4<-foreach(p2=seq(0.1,1,0.1)) %:% foreach(icount(nsim), .combine=rbind) %dopar% {sim(N=N,eprob=eprob,phiv=phiv,PrEP1=PrEP1,PrEP2=PrEP2, p1=p1,p2=p2)}
```


```{r}
# l1<-as.list(seq(0.1,1,0.1))
# l2<-as.list(seq(0.1,1,0.1))
# res5<-foreach(p1=l1, .combine=rbind) %:% foreach(p2=l2, .combine=rbind) %do% {sim_par(N=N,eprob=eprob,phiv=phiv,PrEP1=PrEP1,PrEP2=PrEP2, p1=p1,p2=p2, nsim=100)}
```

```{r}
# params<-tidyr::expand_grid(N=c(20,200,2000,20000),phiv=phiv,PrEP1=PrEP1,PrEP2=PrEP2,p1=seq(0.1,1,0.1),p2=seq(0.1,1,0.1),nsim=nsim)
# res_grid<-purrr::pmap_dfr(params,sim_par)
# beepr::beep()
```


```{r}
# col_list<-names(res_grid)[4:6]
# # means<-res5%>%group_by(p1,p2)%>%summarise_each(mean,c(ran20, `ran10+10`,regen))
# means<-res_grid%>%group_by(N,p1,p2)%>%summarise(across(col_list,mean))
```









